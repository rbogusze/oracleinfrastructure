== Konfiguracja testowego vm ==

=== Dlaczego sendmail uruchamia się tak długo? ===
Próbuje on rozwiązać nazwę hosta tm11201.localdomain i czeka na timeout DNS, którym jest w tym momencie serwer na którym działa klient vmplayer'a.

Aby mu pomóc określ aktualne IP maszyny wirtualnej
{{{
# ifconfig eth0
eth0      Link encap:Ethernet  HWaddr 00:0C:29:3B:E4:25  
          inet addr:192.168.211.174  Bcast:192.168.211.255  
}}}

I taki adres IP wstaw do pliku /etc/hosts, w tym przypadku:
{{{
# vi /etc/hosts
192.168.211.174 tm11201.localdomain tm11201
}}}

=== Zmiana rozdzielczości ekranu pod vmware ===


=== Tworzenie bazy danych ===

Zaloguj się jako oracle na serwer bazodanowy

Potwierdź dostępność narzędzia tworzącego bazę
{{{
$ which dbca
~/db/11.2.0.1/bin/dbca
}}}

Zwolnijmy miejsce na filesystemie
{{{
$ cd /BACKUP/
$ rm arch_*
$ rm db_*
}}}

Utwórzmy pusty katalog na nową bazę
{{{
# mkdir /JASIO
$ id -a
uid=600(oracle) gid=600(dba) groups=600(dba)
# chown oracle:dba /JASIO
$ touch /JASIO/ala_ma_kota
}}}

Upwnij się, że jest wystarczająco dużo wolnego miejsca
{{{
$ df -h
/dev/sda2              18G   14G  3.1G  82% /
}}}

Przy uzyciu kreatora:
{{{
$ dbca
}}}

Strona kodowa: EE8ISO8859P2
/ORABIN/db/admin/JASIO/scripts

Jakie bazy działają na serwerze
{{{
$ ps -ef | grep pmon
}}}

Jak została utworzona moja baza
{{{
alter database backup controlfile to trace;
}}}

Tworzenie spfile z inita
{{{
create spfile from pfile;
startup force 
}}}

*Zadanie 1: Zrestartuj bazy danych JASIO i CZESIODBCA jednocześnie podglądając plik alertlog.*

Ustalenie zmiennych środowiskowych dla konkretnej bazy danych
{{{
$ env | grep ORA
$ cat /etc/oratab
$ . oraenv
}}}

Określenie położenia pliku alert log
{{{
> show parameter dump
background_dump_dest /ORABIN/db/diag/rdbms/jasio/JASIO/trace
}}}

*Zadanie 2: Utwórz 3 grupy redo o wielkości 100M i skasuj stare, w tej samej lokalizacji tylko o innej nazwie*
{{{
> column MEMBER format a50
select * from v$logfile;
select GROUP#,BYTES,STATUS from sys.v$log;

> alter database add logfile group 4 ('/JASIO/oradata/redo100M6a.rdo') size 100M;
> alter database drop logfile group 1;

> alter system switch logfile;
> alter system checkpoint;
}}}

*Zadanie 3: Przełącz bazę w tryb archivelog*
{{{
> select LOG_MODE from v$database;

> show parameter log_archive_dest_1
$ mkdir -p /JASIO/arch
> alter system set log_archive_dest_1='location=/JASIO/arch';
> shutdown immediate
> startup mount
> alter database archivelog;
> alter database open;
> alter system switch logfile;
}}}

*Zadanie 4: Sytuacja awaryjna: Baza nie uruchamia się ze względu na błędną wartość parametru inicjalizacyjnego*
{{{
> alter system set log_archive_format='log_%S.arc' scope=spfile;
> startup force
ORA-19905: log_archive_format must contain %s, %t and %r

> create pfile from spfile;
> shutdown immediate
$ cd $ORACLE_HOME/dbs
$ env | grep ORACLE_SID
ORACLE_SID=JASIO
$ mv spfileJASIO.ora spfileJASIO.ora.bck1
$ vi initJASIO.ora
*.log_archive_format='log_%S_%t_%r.arc'
> startup
> show parameter spfile
NAME				     TYPE	 VALUE
------------------------------------ ----------- --------
spfile				     string
> create spfile from pfile;
> startup force
> show parameter spfile

NAME				     TYPE	 VALUE
------------------------------------ ----------- ----------
spfile				     string	 /ORABIN/db/11.2.0.1/dbs/spfile
						 JASIO.ora
}}}

*Zadanie 5: Zmiana położenia plików bazy danych*
{{{
Zmiana przeprowadzana jest poleceniem:
> alter database rename file '/disk1/file1' to '/disk2/file1';

Przygotuj komendy do zmiany na działającej bazie
> select name from v$datafile;

> set linesize 200
> spool rename.sql
> select 'alter database rename file '''||name||''' to '''||REPLACE(name,'JASIO','KASIA')||'''; ' from v$datafile;
> spool off

Usuwamy śmieci tak żeby zostały tylko komendy 'alter database ...'
$ vi rename.sql

Zamknij bazę 
> shutdown immediate

Fizycznie przesuń pliki
# mkdir /KASIA
# chown oracle:dba /KASIA
$ mkdir /KASIA/KASIA
$ mv /JASIO/JASIO/*.dbf /KASIA/KASIA
> startup mount
> @rename.sql
> alter database open;

}}}

Co się składa na pliki bazy danych
{{{
> set echo on
> @files
}}}

Zmiana położenie plików controlfile
{{{
Określ aktualne położenie plików controlfile
> select value from v$parameter where name='control_files';
/JASIO/JASIO/control01.ctl, /JASIO/JASIO/control02.ctl

Powiedzmy, że ustalamy miejsce docelowe na /KASIA/KASIA
> alter system set control_files='/KASIA/KASIA/control01.ctl','/KASIA/KASIA/control02.ctl' scope=spfile;
> shutdown immediate

Fizycznie zmieniamy położenie plików controlfile
$ mv /JASIO/JASIO/control01.ctl /KASIA/KASIA/control01.ctl
$ mv /JASIO/JASIO/control02.ctl /KASIA/KASIA/control02.ctl

> startup
}}}

*Zadanie 6: konfiguracja sieci*
{{{
Status
$ lsnrctl status

Start
$ lsnrctl start

Stop
$ lsnrctl stop
}}}

Automatyczna rejestracja (po 5 min) baz jeżeli listener działa na porcie defaultowym. Lub wymuszona:
{{{
> alter system register;
}}}


Konfiguracja pliku tnsnames.ora
{{{
$ cd $ORACLE_HOME/network/admin/
}}}

Przykładowy wpis do tnsnames.ora
{{{
$ vim tnsnames.ora
ORACLE =
 (DESCRIPTION =
   (ADDRESS_LIST =
     (ADDRESS = (PROTOCOL = TCP)(Host = 10.0.255.193)(Port = 1521))
   )
 (CONNECT_DATA =
   (SERVICE_NAME = TEST)
 )
)

$ tnsping ORACLE
}}}

*Zadanie 6: konfiguracja konsoli administratora*

Określenie statusu, jeżeli uruchomiona podaje adres pod jakim jest dostępna, np. https://oracle1:5500/em/ Logowanie jako użytkownik bazodanowy system.
{{{
$ export ORACLE_UNQNAME=$ORACLE_SID

$ emctl status dbconsole
}}}

Uruchomienie
{{{
$ emctl start dbconsole
}}}

Zatrzymanie
{{{
$ emctl stop dbconsole
}}}

Rekonfiguracja
{{{
$ emca -deconfig dbcontrol db -repos drop
$ emca -config dbcontrol db -repos create
}}}

== Instalacja ASMLib ==

Określ wersję jądra linuksa
{{{
# uname -a
Linux tm11201 2.6.18-274.el5 #1 SMP Fri Jul 22 04:43:29 EDT 2011 x86_64 x86_64 x86_64 GNU/Linux
# cat /etc/redhat-release 
CentOS release 5.7 (Final)

http://www.oracle.com/technetwork/topics/linux/asmlib/index-101839.html

Red Hat Enterprise Linux 5 AS -> Intel EM64T (x86_64) Architecture -> 

# wget http://download.oracle.com/otn_software/asmlib/oracleasmlib-2.0.4-1.el5.x86_64.rpm

# wget http://oss.oracle.com/projects/oracleasm-support/dist/files/RPMS/rhel5/amd64/2.1.8/oracleasm-support-2.1.8-1.el5.x86_64.rpm

# wget http://oss.oracle.com/projects/oracleasm/dist/files/RPMS/rhel5/amd64/2.0.5/2.6.18-274.el5/oracleasm-2.6.18-274.el5-2.0.5-1.el5.x86_64.rpm

Instalacja:
# rpm -ivh oracleasmlib-2.0.4-1.el5.x86_64.rpm oracleasm-2.6.18-274.el5-2.0.5-1.el5.x86_64.rpm oracleasm-support-2.1.8-1.el5.x86_64.rpm
Preparing...                ########################################### [100%]
   1:oracleasm-support      ########################################### [ 33%]
   2:oracleasm-2.6.18-274.el########################################### [ 67%]
   3:oracleasmlib           ########################################### [100%]

# fdisk -l
# fdisk /dev/sdb
n   add a new partition
p   primary partition (1-4)
p
Partition number (1-4): 1
First cylinder (1-2219, default 1): 
Using default value 1
Last cylinder or +size or +sizeM or +sizeK (1-2219, default 2219): 
Using default value 2219

Command (m for help): p

Disk /dev/sdb: 18.2 GB, 18253611008 bytes
255 heads, 63 sectors/track, 2219 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1               1        2219    17824086   83  Linux

Command (m for help): w
The partition table has been altered!

}}}

Naznaczanie urządzeń tagiem ASMlib
{{{
# /etc/init.d/oracleasm configure
Default user to own the driver interface []: oracle
Default group to own the driver interface []: dba
Start Oracle ASM library driver on boot (y/n) [n]: y
Scan for Oracle ASM disks on boot (y/n) [y]: y

# /etc/init.d/oracleasm createdisk DATA1 /dev/sdb1
Marking disk "DATA1" as an ASM disk:                       [  OK  ]

# /usr/sbin/oracleasm listdisks
DATA1

# ls -l /dev/oracleasm/disks
}}}


Czyścimy miejsce
{{{
Kasowanie bazy danych

Ustaw środowisko wybranej bazy danych
$ cd
$ . menu.sh
ORACLE_SID: ZENEKDBCA

Wystartuj bazę w trybie mount restrict
> shutdown abort
> startup mount restrict

Upewnij się, że to na pewno baza którą chcesz skasować
> show parameter name
$ env | grep ORACLE_SID

$ rlwrap rman target /
RMAN> list archivelog all;
RMAN> delete archivelog all;

RMAN> crosscheck backup;
RMAN> delete expired backup;

RMAN> list backup;
RMAN> delete backup;

RMAN> drop database;

Skasuj wpis nieistniejącej bazy z pliku oratab
$ vi /etc/oratab
-> to skasuj ZENEKDBCA:/ORABIN...
}}}